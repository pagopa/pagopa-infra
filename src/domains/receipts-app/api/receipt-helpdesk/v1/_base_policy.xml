<policies>
    <inbound>
        <base />
        <set-variable name="backendBaseUrl"
                      value="https://${hostname}"/>
        <!--
            Redirect Logic
            - healthCheck and GET Receipts and Cart operations -> pdf-service
            - Recover operations -> pdf-datastore
            - RegenerateReceiptPdf -> pdf-generator
         -->
        <choose>
            <when condition="@(context.Operation.Id == "RegenerateReceiptPdf")">
                <set-variable name="servicePath" value="pagopa-receipt-pdf-generator-helpdesk"/>
            </when>
            <when condition="@(new [] {
                    "healthCheck", "GetReceipt", "GetReceiptByOrganizationFiscalCodeAndIUV",
                    "GetReceiptMessage", "GetReceiptPdf", "GetReceiptError", "GetCart"
                    }.Contains(context.Operation.Id))">
                <set-variable name="servicePath" value="pagopa-receipt-pdf-service-helpdesk"/>
            </when>
            <when condition="@(new [] {
                    "ReceiptToReviewed", "RecoverFailedReceipt", "RecoverFailedReceiptMassive",
                    "RecoverNotNotifiedReceipt", "RecoverNotNotifiedReceiptMassive",
                    "RecoverFailedCart", "RecoverFailedCartMassive"
                    }.Contains(context.Operation.Id))">
                <set-variable name="servicePath" value="pagopa-receipt-pdf-datastore-helpdesk"/>
                <choose>
                    <!-- rewrite-uri is necessary because path has been changed for RecoverFailedCart and RecoverFailedCartMassive -->
                    <when condition="@(context.Operation.Id == "RecoverFailedCart")">
                        <rewrite-uri template="/cart-receipts/{cart-id}/recover-failed"/>
                    </when>
                    <when condition="@(context.Operation.Id == "RecoverFailedCartMassive")">
                        <rewrite-uri template="/cart-receipts/recover-failed"/>
                    </when>
                </choose>
            </when>
            <otherwise>
                <set-variable name="servicePath" value="pagopa-receipt-pdf-helpdesk"/>
            </otherwise>
        </choose>
        <set-backend-service base-url="@((string)context.Variables["backendBaseUrl"] + "/"+ (string)context.Variables["servicePath"])"/>
    </inbound>
    <outbound>
    <base />
    </outbound>
    <backend>
    <base />
    </backend>
    <on-error>
    <base />
    </on-error>
</policies>