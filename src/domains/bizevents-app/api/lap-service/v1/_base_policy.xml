<policies>
    <inbound>
        <base />
        <!-- rate limit by subscription key -->
        <!-- <rate-limit calls="300" renewal-period="10" remaining-calls-variable-name="remainingCallsPerSubscription"/> -->
        <set-backend-service base-url="https://${hostname}/pagopa-biz-events-service" />
    </inbound>
    <outbound>
        <base />
        <choose>
            <when condition="@(!context.Request.Url.Path.Contains("pdf") && context.Operation.Method.Equals("GET") )">
                <set-body>@{
                    var originalResponseBody = context.Response.Body.As<string>(preserveContent: true);
                    try { 
                        var body = JObject.Parse(originalResponseBody);
                        if (body["infoNotice"]?["origin"]?.ToString() == "NDP004PROD") {
                            body["infoNotice"]["origin"] = "NDP003PROD";
                        }
                        return body.ToString();
                    }
                    catch(Exception e) {
                        //cannot parse response body as JSON, returning original body
                        return originalResponseBody;
                    }
                }</set-body>
            </when>
        </choose>
    </outbound>
    <backend>
        <base />
    </backend>
    <on-error>
        <base />
    </on-error>
</policies>
