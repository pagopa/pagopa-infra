<policies>
    <inbound>
        <!-- operation before base policy -->
        <base />
        <!-- operation after base policy -->

        <!-- Extracting all payments tokens, then extract the first for routing purposes. The other tokens will be used in outbound policy. -->
        <set-variable name="paymentTokens" value="@{
          // Setting payment token value with default value
          var paymentTokens = "";
          // Extracting required field from request body
          XElement request = context.Request.Body.As<XElement>(preserveContent: true);
          XElement body = request.Descendants(request.Name.Namespace + "Body").FirstOrDefault();
          if (body != null ) {
            XElement primitive = (XElement) body.FirstNode;
            XElement paymentTokensNode = primitive.Descendants("paymentTokens").FirstOrDefault();
            if (paymentTokensNode != null) {
              paymentTokens = String.Join(",", paymentTokensNode.Elements().Select(token => token.Value));
            }
          }
          return paymentTokens;
        }" />

        <include-fragment fragment-id="ndp-set-node-id-by-token-policy" />
        <include-fragment fragment-id="ndp-spo-inbound-policy" />
        <include-fragment fragment-id="ndp-set-base-url-policy" />

    </inbound>
    <backend>
        <!-- operation before base policy -->
        <base />
        <!-- operation after base policy -->
    </backend>
    <outbound>
        <!-- operation before base policy -->
        <base />
        <!-- operation after base policy -->
        <!-- estrai tokens in split da variabile "paymentTokens", esegui fragment x5 volte -->
        <include-fragment fragment-id="ndp-end-payment-cache-removal-outbound-policy" />

    </outbound>
    <on-error>
        <!-- operation before base policy -->
        <base />
        <!-- operation after base policy -->
    </on-error>
</policies>
