<policies>
  <inbound>
    <!-- operation before base policy -->
    <base />
    <!-- operation after base policy -->

    <include-fragment fragment-id="ndp-extract-paymentTokens-json-policy"/>
    <include-fragment fragment-id="ndp-set-node-id-by-token-policy" />
    <include-fragment fragment-id="ndp-set-base-url-policy" />

  </inbound>
  <backend>
    <!-- operation before base policy -->
    <base />
    <!-- operation after base policy -->
  </backend>
  <outbound>
    <!-- operation before base policy -->
    <base />
    <!-- operation after base policy -->

    <!-- extract requestOutcome and responseOutcome-->
    <include-fragment fragment-id="ndp-set-outcome-request-response-json-policy" />

    <!-- Remove objects in cache iff outcome is KO, otherwise do nothing -->
    <choose>
        <!-- check if outcome in request is KO -->
        <when condition="@(context.Variables.GetValueOrDefault<string>("requestOutcome", "NONE").Equals("KO") || context.Variables.GetValueOrDefault<string>("responseOutcome", "NONE").Equals("KO"))">
            <!-- estrai tokens in split da variabile "paymentTokens", esegui fragment x5 volte -->
            <include-fragment fragment-id="ndp-end-payment-cache-removal-outbound-policy" />
        </when>
    </choose>
  
    <!-- Trace variables dinamically as response headers -->
    <include-fragment fragment-id="trace-variable-as-header-policy" />

  </outbound>
  <on-error>
    <!-- operation before base policy -->
    <base />
    <!-- operation after base policy -->
  </on-error>
</policies>
