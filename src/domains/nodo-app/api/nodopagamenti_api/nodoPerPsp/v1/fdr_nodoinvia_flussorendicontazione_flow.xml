<!-- https://github.com/Azure/api-management-policy-snippets/blob/master/examples/PUT%20a%20file%20to%20blobStorage%20account.xml -->
<policies>
    <inbound>
        <base />
        <set-variable name="readrequest" value="@(context.Request.Body.As<string>(preserveContent: true))" />
        <set-variable name="identificativoPSP" value="@{
            var dom2parse = ((string) context.Variables["readrequest"]);
            String[] spearator = {"identificativoPSP"};
            String[] result = dom2parse.Split(spearator, StringSplitOptions.RemoveEmptyEntries);
            var identificativoPSP = result.Length > 2 ? result[1].Substring(1,result[1].Length-3).Replace("xmlns=\"\">", "") : "identificativoPSP";
            return identificativoPSP;
        }" />
        <set-variable name="identificativoIntermediarioPSP" value="@{
            var dom2parse = ((string) context.Variables["readrequest"]);
            String[] spearator = {"identificativoIntermediarioPSP"};
            String[] result = dom2parse.Split(spearator, StringSplitOptions.RemoveEmptyEntries);
            var identificativoIntermediarioPSP = result.Length > 2 ? result[1].Substring(1,result[1].Length-3).Replace("xmlns=\"\">", "") : "";
            return identificativoIntermediarioPSP;
        }" />
        <set-variable name="identificativoCanale" value="@{
            var dom2parse = ((string) context.Variables["readrequest"]);
            String[] spearator = {"identificativoCanale"};
            String[] result = dom2parse.Split(spearator, StringSplitOptions.RemoveEmptyEntries);
            var identificativoCanale = result.Length > 2 ? result[1].Substring(1,result[1].Length-3).Replace("xmlns=\"\">", "") : "";
            return identificativoCanale;
        }" />
        <set-variable name="identificativoDominio" value="@{
            var dom2parse = ((string) context.Variables["readrequest"]);
            String[] spearator = {"identificativoDominio"};
            String[] result = dom2parse.Split(spearator, StringSplitOptions.RemoveEmptyEntries);
            var identificativoDominio = result.Length > 2 ? result[1].Substring(1,result[1].Length-3).Replace("xmlns=\"\">", "") : "";
            return identificativoDominio;
        }" />
        <set-variable name="identificativoFlusso" value="@{
            var dom2parse = ((string) context.Variables["readrequest"]);
            String[] spearator = {"identificativoFlusso"};
            String[] result = dom2parse.Split(spearator, StringSplitOptions.RemoveEmptyEntries);
            var identificativoFlusso = result.Length > 2 ? result[1].Substring(1,result[1].Length-3).Replace("xmlns=\"\">", "") : "";
            return identificativoFlusso;
        }" />
        <set-variable name="dataOraFlusso" value="@{
            var dom2parse = ((string) context.Variables["readrequest"]);
            String[] spearator = {"dataOraFlusso"};
            String[] result = dom2parse.Split(spearator, StringSplitOptions.RemoveEmptyEntries);
            var dataOraFlusso = result.Length > 2 ? result[1].Substring(1,result[1].Length-3).Replace("xmlns=\"\">", "") : "";
            return dataOraFlusso;
        }" />
        <set-variable name="xmlRendicontazione" value="@{
            var dom2parse = ((string) context.Variables["readrequest"]);
            String[] spearator = {"xmlRendicontazione"};
            String[] result = dom2parse.Split(spearator, StringSplitOptions.RemoveEmptyEntries);
            var xmlRendicontazione = result.Length > 2 ? result[1].Substring(1,result[1].Length-3).Replace("xmlns=\"\">", "") : "xmlRendicontazione";
            return xmlRendicontazione;
        }" />
        <cache-store-value key="@{
            var fdrFileName=(string) context.Variables["identificativoPSP"]+"--"+context.Variables["identificativoIntermediarioPSP"]+"--"+context.Variables["identificativoCanale"]+"--"+context.Variables["identificativoDominio"]+"--"+context.Variables["identificativoFlusso"]+"--"+context.Variables["dataOraFlusso"];
            return fdrFileName;
        }" value="@((string) context.Variables["xmlRendicontazione"])" duration="3600" caching-type="internal" />

        <!-- <set-backend-service base-url="{{urlnodo}}" />  onprem -->
        <set-backend-service base-url="http://{{aks-lb-nexi}}{{base-path-nodo-oncloud}}/webservices/input" />
        <choose>
            <when condition="@(((string)context.Request.Headers.GetValueOrDefault("X-Orginal-Host-For","")).Contains("prf.platform.pagopa.it") || ((string)context.Request.OriginalUrl.ToUri().Host).Contains("prf.platform.pagopa.it"))">
                <set-backend-service base-url="http://{{aks-lb-nexi}}/nodo-prf/webservices/input" />
            </when>
        </choose>
        
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <set-variable name="originalrsp" value="@(context.Response.Body.As<string>())" />
        <cache-lookup-value key="@{
                var fdrFileName=(string) context.Variables["identificativoPSP"]+"--"+context.Variables["identificativoIntermediarioPSP"]+"--"+context.Variables["identificativoCanale"]+"--"+context.Variables["identificativoDominio"]+"--"+context.Variables["identificativoFlusso"]+"--"+context.Variables["dataOraFlusso"];
                return fdrFileName;
            }" variable-name="xmlRendicontazione" caching-type="internal" />
        <set-variable name="esito" value="@{
                var response = (string) context.Variables["originalrsp"];
                String[] spearator = {"esito"};
                String[] result = response.Split(spearator, StringSplitOptions.RemoveEmptyEntries);
                var esito = result[1].Substring(1,result[1].Length-3);
                return esito;
            }" />
        <choose>
            <when condition="@("OK".Equals((string)context.Variables["esito"]) && context.Response.StatusCode == 200)">
                <!-- <when condition="@(context.Response.StatusCode == 200)"> -->
                <!-- First get the auth token with managed-identity from the storage account and save it on a output token -->
                <authentication-managed-identity resource="https://storage.azure.com/" output-token-variable-name="msi-access-token" ignore-error="false" />
                <!-- Send the PUT request with metadata -->
                <send-request mode="new" response-variable-name="result" timeout="300" ignore-error="false">
                    <!-- Get variables to configure your: storageaccount, destination container and file name with extension -->
                    <set-url>@{
                        var fdrFileName=(string) context.Variables["identificativoPSP"]+"--"+context.Variables["identificativoIntermediarioPSP"]+"--"+context.Variables["identificativoCanale"]+"--"+context.Variables["identificativoDominio"]+"--"+context.Variables["identificativoFlusso"]+"--"+context.Variables["dataOraFlusso"]+".xml";
                        return "https://{{fdrsaname}}.blob.core.windows.net/" + "{{fdrcontainername}}" + "/" + fdrFileName;
                        }</set-url>
                    <set-method>PUT</set-method>
                    <set-header name="Host" exists-action="override">
                        <value>{{fdrsaname}}.blob.core.windows.net</value>
                        <!-- <value>pagopaunodotestsa.blob.core.windows.net</value> -->
                    </set-header>
                    <set-header name="X-Ms-Blob-Type" exists-action="override">
                        <value>BlockBlob</value>
                    </set-header>
                    <set-header name="X-Ms-Blob-Cache-Control" exists-action="override">
                        <value />
                    </set-header>
                    <set-header name="X-Ms-Blob-Content-Disposition" exists-action="override">
                        <value />
                    </set-header>
                    <set-header name="X-Ms-Blob-Content-Encoding" exists-action="override">
                        <value />
                    </set-header>
                    <set-header name="X-Ms-Blob-Content-Language" exists-action="override">
                        <value />
                    </set-header>
                    <set-header name="X-Ms-Version" exists-action="override">
                        <value>2019-12-12</value>
                    </set-header>
                    <set-header name="Accept" exists-action="override">
                        <value>application/json</value>
                    </set-header>
                    <!-- Set the header with authorization bearer token that was previously requested -->
                    <set-header name="Authorization" exists-action="override">
                        <value>@("Bearer " + (string)context.Variables["msi-access-token"])</value>
                    </set-header>
                    <!-- Set the file content from the original request body data -->
                    <!-- <set-body>@(context.Request.Body.As<string>())</set-body> -->
                    <set-body>@((string)context.Variables["xmlRendicontazione"])</set-body>
                </send-request>
            </when>
        </choose>
        <return-response>
            <set-header name="Content-Type" exists-action="override">
                <value>text/xml</value>
            </set-header>
            <set-body>@((string)context.Variables["originalrsp"])</set-body>
        </return-response>
        <base />
        
        <!-- Trace variables dinamically as response headers -->
        <include-fragment fragment-id="trace-variable-as-header-policy" />
    </outbound>
    <on-error>
        <base />
    </on-error>
</policies>
