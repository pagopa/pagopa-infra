<fragment>
  <!-- extract info from request -->
  <set-variable name="requestInfo" value="@{
        // retrieve data from request body
        XElement request = context.Request.Body.As<XElement>(preserveContent: true);
        XElement body = request.Descendants(request.Name.Namespace + "Body").FirstOrDefault();

        var requestInfo = new JObject();

        requestInfo.Add(new JProperty("fiscalCode", ""));
  requestInfo.Add(new JProperty("noticeNumber", ""));
  requestInfo.Add(new JProperty("transactionId", ""));

  try {
  if (body != null ) {
  XElement primitive = (XElement) body.FirstNode;
  var fiscalCode = primitive.Descendants("fiscalCode").FirstOrDefault().Value;
  var noticeNumber = primitive.Descendants("noticeNumber").FirstOrDefault().Value;

  requestInfo["fiscalCode"] = fiscalCode;
  requestInfo["noticeNumber"] = noticeNumber;
  }
  }
  catch (Exception e) {
  // do nothing
  }
  return requestInfo.ToString();
  }" />

  <!-- the requestInfo MUST contains fiscalCode, noticeNumber and transactionId info -->
  <cache-lookup-value key="@{
        var domain = context.Variables.GetValueOrDefault<string>("domain", "nodo");
        var requestInfo = JObject.Parse((string)context.Variables["requestInfo"]);

        return domain + "_" + (string)requestInfo["fiscalCode"] + "_" + (string)requestInfo["noticeNumber"];
      }" variable-name="nodo_fiscalCode_noticeNumber" default-value="NONE" caching-type="external" />

  <cache-lookup-value key="@{
        var domain = context.Variables.GetValueOrDefault<string>("domain_eCommerce", "eCommerce");
        var requestInfo = JObject.Parse((string)context.Variables["requestInfo"]);

        return domain + "_" + (string)requestInfo["transactionId"];
      }" variable-name="eCommerce_transactionId" default-value="NONE" caching-type="external" />


  <!-- Setting baseNodeId based on nodo_fiscalCode_noticeNumber and eCommerce_transactionId values. NONE is False, !NONE is True -->
  <choose>
    <!-- True, * -->
    <when condition="@(!context.Variables.GetValueOrDefault<string>("nodo_fiscalCode_noticeNumber", "NONE").Equals("NONE"))">
    <!-- set baseNodeId -->
    <set-variable name="baseNodeId" value="@(context.Variables.GetValueOrDefault<string>("nodo_fiscalCode_noticeNumber", "NONE"))" />
  </when>
  <!-- False, * -->
  <otherwise>
    <choose>
      <!-- False, True -->
      <when condition="Boolean expression | Boolean constant">
        <!— one or more policy statements to be applied if the above condition is true  -->
      </when>
      <!-- False, False -->
      <otherwise>
        <!— one or more policy statements to be applied if the above condition is true  -->
      </otherwise>
    </choose>
  </otherwise>
</choose>

  </fragment>
