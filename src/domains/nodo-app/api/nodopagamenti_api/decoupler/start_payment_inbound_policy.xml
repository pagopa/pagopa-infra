<fragment>
  <!-- extract info from request -->
  <set-variable name="requestInfo" value="@{
        // retrieve data from request body
        XElement request = context.Request.Body.As<XElement>(preserveContent: true);
        XElement body = request.Descendants(request.Name.Namespace + "Body").FirstOrDefault();

        var requestInfo = new JObject();

        requestInfo.Add(new JProperty("fiscalCode", ""));
  requestInfo.Add(new JProperty("noticeNumber", ""));
  requestInfo.Add(new JProperty("transactionId", ""));

  try {
  if (body != null ) {
  XElement primitive = (XElement) body.FirstNode;
  var fiscalCode = primitive.Descendants("fiscalCode").FirstOrDefault().Value;
  var noticeNumber = primitive.Descendants("noticeNumber").FirstOrDefault().Value;

  requestInfo["fiscalCode"] = fiscalCode;
  requestInfo["noticeNumber"] = noticeNumber;
  }
  }
  catch (Exception e) {
  // do nothing
  }
  return requestInfo.ToString();
  }" />

  <!-- the requestInfo MUST contains fiscalCode, noticeNumber and transactionId info -->
  <cache-lookup-value key="@{
        var domain = context.Variables.GetValueOrDefault<string>("domain", "nodo");
        var requestInfo = JObject.Parse((string)context.Variables["requestInfo"]);

        return domain + "_" + (string)requestInfo["fiscalCode"] + "_" + (string)requestInfo["noticeNumber"];
      }" variable-name="nodo_fiscalCode_noticeNumber" default-value="NONE" caching-type="external" />

  <cache-lookup-value key="@{
        var domain = context.Variables.GetValueOrDefault<string>("domain_eCommerce", "eCommerce");
        var requestInfo = JObject.Parse((string)context.Variables["requestInfo"]);

        return domain + "_" + (string)requestInfo["transactionId"];
      }" variable-name="eCommerce_transactionId" default-value="NONE" caching-type="external" />


  <!-- Setting baseNodeId based on nodo_fiscalCode_noticeNumber and eCommerce_transactionId values. NONE is False, !NONE is True -->
  <choose>
    <!-- True, * -->
    <when condition="@(!context.Variables.GetValueOrDefault<string>("nodo_fiscalCode_noticeNumber", "NONE").Equals("NONE"))">
    <!-- set baseNodeId -->
    <set-variable name="baseNodeId" value="@(context.Variables.GetValueOrDefault<string>("nodo_fiscalCode_noticeNumber", "NONE"))" />
  </when>
  <!-- False, * -->
  <otherwise>
    <choose>
      <!-- False, True -->
      <when condition="@(!context.Variables.GetValueOrDefault<string>("eCommerce_transactionId", "NONE").Equals("NONE"))">
      <!-- set baseNodeId -->
      <set-variable name="baseNodeId" value="@(context.Variables.GetValueOrDefault<string>("eCommerce_transactionId", "NONE"))" />
    </when>
    <!-- False, False -->
    <otherwise>
      <!-- temporary patch: eCommerce bridge to default -->

      <!-- LIST algorithm -->
      <set-variable name="enable_nm3_switch" value="{{enable-nm3-decoupler-switch}}" />
      <set-variable name="ndp_eCommerce_transactionId_ttl" value="{{ndp-eCommerce-transactionId-ttl}}" />
      <set-variable name="ndp_nodo_fiscalCode_noticeNumber_ttl" value="{{ndp-nodo-fiscalCode-noticeNumber-ttl}}" />
      <!-- Sort configuration according to list priority -->
      <set-variable name="configuration" value="@{
            JArray json_configuration = JArray.Parse(((string) context.Variables["configuration"]));
            JArray sorted = new JArray(json_configuration.OrderBy(obj => (int)obj["list_priority"]));
            return sorted.ToString();
        }" />
      <set-variable name="baseNodeId" value="@{
            bool enable_nm3_switch = context.Variables.GetValueOrDefault<string>("enable_nm3_switch", "").Equals("true");
      var configuration = JArray.Parse(context.Variables.GetValueOrDefault<string>("configuration"));
      var requestInfo = JObject.Parse((string)context.Variables["requestInfo"]);

      if (enable_nm3_switch) {
      foreach (JObject item in configuration) {
      var cis = item.GetValue("cis").ToList();

      if (cis.Count == 0 || (cis.Count > 0 && cis.Contains((string)requestInfo["fiscalCode"]))) {
      return item.GetValue("node_id").ToString();
      }
      }
      }

      return context.Variables.GetValueOrDefault<string>("baseNodeId", "NONE");
      }" />

      <!-- cache store (key = eCommerce_transactionId, value = baseNodeId) -->
      <cache-store-value key="@{
        var domain = context.Variables.GetValueOrDefault<string>("domain_eCommerce", "eCommerce");
        var requestInfo = JObject.Parse((string)context.Variables["requestInfo"]);

        return domain + "_" + (string)requestInfo["transactionId"];
      }" value="@(context.Variables.GetValueOrDefault<string>("baseNodeId", "NONE"))" duration="@((int)context.Variables.GetValueOrDefault("ndp_eCommerce_transactionId_ttl", 86400))" caching-type="external" />
    </otherwise>
  </choose>
  <!-- cache store (key = nodo_fiscalCode_noticeNumber, value = baseNodeId) -->
  <cache-store-value key="@{
        var domain = context.Variables.GetValueOrDefault<string>("domain", "nodo");
        var requestInfo = JObject.Parse((string)context.Variables["requestInfo"]);

        return domain + "_" + (string)requestInfo["fiscalCode"] + "_" + (string)requestInfo["noticeNumber"];
    }" value="@(context.Variables.GetValueOrDefault<string>("baseNodeId", "NONE"))" duration="@((int)context.Variables.GetValueOrDefault("ndp_nodo_fiscalCode_noticeNumber_ttl", 5184000))" caching-type="external" />
</otherwise>
  </choose>

  <!-- set BASE_URL -->

  </fragment>
