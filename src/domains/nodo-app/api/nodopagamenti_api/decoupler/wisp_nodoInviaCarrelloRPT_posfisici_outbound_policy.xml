<!-- @formatter:off -->
<fragment>
    <!-- ################################################################## -->
    <!-- START WISP-NODOINVIACARRELLORPT-POSFISICI-OUTBOUND-POLICY FRAGMENT -->
    <!-- ################################################################## -->

    <choose>
        <when condition="@(context.Variables.GetValueOrDefault<bool>("is_wfesp", false))">
            <set-variable name="outcome_wfesp_cart" value="@{
                string outcomeWfespCart = "";
                try {
                    XElement response = context.Response.Body.As<XElement>(preserveContent: true);
                    XElement body = response.Descendants(response.Name.Namespace + "Body").FirstOrDefault();
                    XElement primitive = (XElement) body.FirstNode;
                    outcomeWfespCart = (string) primitive.Descendants("esitoComplessivoOperazione").FirstOrDefault();
                } catch (Exception e) {
                    // nothing to do
                }
                return outcomeWfespCart;
                }" />
            <choose>
                <when condition="@(context.Variables.GetValueOrDefault<string>("outcome_wfesp_cart", "").Equals("OK"))">
                    <set-variable name="wfesp_fixed_url" value="{{wfesp-fixed-url}}" />
                    <set-variable name="wfesp_fixed_url_completed" value="@(((string)context.Variables["wfesp_fixed_url"]) + context.Response.Headers.GetValueOrDefault("sessionId"))" />
                    <set-header name="Content-Type" exists-action="override">
                        <value>text/xml</value>
                    </set-header>
                    <set-body template="liquid">
                        <soapenv:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ppt="http://ws.pagamenti.telematici.gov/" xmlns:tns="http://NodoPagamentiSPC.spcoop.gov.it/servizi/PagamentiTelematiciRPT" xmlns:ppthead="http://ws.pagamenti.telematici.gov/ppthead">
                            <soapenv:Body>
                                <ppt:nodoInviaCarrelloRPTRisposta>
                                    <esitoComplessivoOperazione>OK</esitoComplessivoOperazione>
                                    <url>{{context.Variables["wfesp_fixed_url_completed"]}}</url>
                                </ppt:nodoInviaCarrelloRPTRisposta>
                            </soapenv:Body>
                        </soapenv:Envelope>
                    </set-body>
                </when>
            </choose>
        </when>
    </choose>

    <!-- ################################################################ -->
    <!-- END WISP-NODOINVIACARRELLORPT-POSFISICI-OUTBOUND-POLICY FRAGMENT -->
    <!-- ################################################################ -->
</fragment>
